---
- name: Set target user facts
  ansible.builtin.set_fact:
    target_user: "{{ lookup('ansible.builtin.env', 'SUDO_USER') | default(lookup('ansible.builtin.env', 'USER'), true) }}"
    target_home: "{{ lookup('ansible.builtin.env', 'HOME') | default('/home/' ~ lookup('ansible.builtin.env', 'SUDO_USER') | default(lookup('ansible.builtin.env', 'USER'), true), true) }}"
  tags:
    - base_packages
    - facts

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  tags:
    - base_packages
    - apt

- name: Install base packages
  ansible.builtin.apt:
    name: "{{ base_packages_apt }}"
    state: present
  tags:
    - base_packages
    - apt

- name: Download Starship installer
  ansible.builtin.get_url:
    url: https://starship.rs/install.sh
    dest: /tmp/starship-install.sh
    mode: "0755"
  tags:
    - base_packages
    - starship

- name: Configure unattended upgrades
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/etc/apt/apt.conf.d/{{ item }}"
    owner: root
    group: root
    mode: "0644"
  loop:
    - 20auto-upgrades
    - 50unattended-upgrades
  tags:
    - base_packages
    - unattended_upgrades

- name: Install Starship
  ansible.builtin.command:
    cmd: /tmp/starship-install.sh -y
    creates: /usr/local/bin/starship
  tags:
    - base_packages
    - starship

- name: Download Atuin installer
  ansible.builtin.get_url:
    url: https://setup.atuin.sh
    dest: /tmp/atuin-install.sh
    mode: "0755"
  become: false
  tags:
    - base_packages
    - atuin

- name: Install Atuin
  ansible.builtin.command:
    cmd: /bin/sh /tmp/atuin-install.sh
    creates: "{{ target_home }}/.atuin/bin/atuin"
  environment:
    HOME: "{{ target_home }}"
    USER: "{{ target_user }}"
    LOGNAME: "{{ target_user }}"
    ATUIN_INSTALL_DIR: "{{ target_home }}/.atuin/bin"
  become: false
  tags:
    - base_packages
    - atuin

- name: Download uv installer
  ansible.builtin.get_url:
    url: https://astral.sh/uv/install.sh
    dest: /tmp/uv-install.sh
    mode: "0755"
  become: false
  tags:
    - base_packages
    - uv

- name: Install uv
  ansible.builtin.command:
    cmd: /bin/sh /tmp/uv-install.sh
    creates: "{{ target_home }}/.local/bin/uv"
  environment:
    HOME: "{{ target_home }}"
    USER: "{{ target_user }}"
  become: false
  tags:
    - base_packages
    - uv

- name: Fail if no sudo user for .bashrc install
  ansible.builtin.fail:
    msg: "Refusing to manage .bashrc without SUDO_USER; run via sudo as the target user."
  when:
    - target_user == 'root'
    - (lookup('ansible.builtin.env', 'SUDO_USER') | default('', true)) == ''
  become: false
  tags:
    - base_packages
    - bashrc

- name: Manage user .bashrc
  ansible.builtin.copy:
    src: bashrc
    dest: "{{ target_home }}/.bashrc"
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0644"
  become: false
  tags:
    - base_packages
    - bashrc

- name: Get current timezone
  ansible.builtin.command:
    cmd: timedatectl show -p Timezone --value
  register: current_timezone
  changed_when: false
  tags:
    - base_packages
    - timezone

- name: Set system timezone
  ansible.builtin.command:
    cmd: timedatectl set-timezone {{ base_packages_timezone }}
  when: current_timezone.stdout != base_packages_timezone
  changed_when: true
  tags:
    - base_packages
    - timezone
