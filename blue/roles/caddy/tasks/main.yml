---
- name: Ensure Caddy configuration directory exists
  ansible.builtin.file:
    path: /etc/caddy
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags:
    - caddy

- name: Fail if Cloudflare API token is missing
  ansible.builtin.assert:
    that:
      - caddy_cloudflare_api_token is defined
      - caddy_cloudflare_api_token | length > 0
    fail_msg: "Set caddy_cloudflare_api_token (recommend Ansible Vault) before configuring Caddy."
  tags:
    - caddy

- name: Install Caddy env file
  ansible.builtin.template:
    src: caddy.env.j2
    dest: /etc/caddy/caddy.env
    owner: root
    group: root
    mode: "0600"
  notify:
    - reload systemd
    - restart caddy
  tags:
    - caddy

- name: Install Caddyfile
  ansible.builtin.template:
    src: Caddyfile.j2
    dest: /etc/caddy/Caddyfile
    owner: root
    group: root
    mode: "0644"
  notify:
    - reload systemd
    - restart caddy
  tags:
    - caddy

- name: Ensure quadlet directory exists
  ansible.builtin.file:
    path: /etc/containers/systemd
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags:
    - caddy
    - quadlet

- name: Install Caddy quadlet
  ansible.builtin.template:
    src: caddy.container.j2
    dest: /etc/containers/systemd/caddy.container
    owner: root
    group: root
    mode: "0644"
  notify:
    - reload systemd
    - restart caddy
  tags:
    - caddy
    - quadlet

- name: Flush systemd reload handler
  ansible.builtin.meta: flush_handlers
  tags:
    - caddy

- name: Enable and start Caddy
  ansible.builtin.systemd:
    name: caddy.service
    enabled: true
    state: started
  tags:
    - caddy
