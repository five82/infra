---
- name: Fail if no sudo user for Jellyfin config
  ansible.builtin.fail:
    msg: "Refusing to manage Jellyfin config under HOME without SUDO_USER; run via sudo as the target user."
  when:
    - (lookup('ansible.builtin.env', 'SUDO_USER') | default('', true)) == ''
    - (lookup('ansible.builtin.env', 'USER') | default('root', true)) == 'root'
  become: false
  tags:
    - jellyfin

- name: Set Jellyfin user fact
  ansible.builtin.set_fact:
    jellyfin_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id, true) }}"
  tags:
    - jellyfin
    - facts

- name: Read Jellyfin user entry
  ansible.builtin.command:
    cmd: "getent passwd {{ jellyfin_user }}"
  changed_when: false
  register: jellyfin_getent
  tags:
    - jellyfin
    - facts

- name: Set Jellyfin home/uid/gid facts
  ansible.builtin.set_fact:
    jellyfin_home: "{{ jellyfin_getent.stdout.split(':')[5] }}"
    jellyfin_uid: "{{ jellyfin_getent.stdout.split(':')[2] }}"
    jellyfin_gid: "{{ jellyfin_getent.stdout.split(':')[3] }}"
  tags:
    - jellyfin
    - facts

- name: Ensure Jellyfin user is in video group
  ansible.builtin.user:
    name: "{{ jellyfin_user }}"
    groups:
      - video
    append: true
  tags:
    - jellyfin

- name: Ensure Jellyfin config/cache directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ jellyfin_uid }}"
    group: "{{ jellyfin_gid }}"
    mode: "0755"
  loop:
    - "{{ jellyfin_home }}/.jellyfin"
    - "{{ jellyfin_home }}/.jellyfin/config"
    - "{{ jellyfin_home }}/.jellyfin/cache"
  tags:
    - jellyfin

- name: Ensure quadlet directory exists
  ansible.builtin.file:
    path: /etc/containers/systemd
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags:
    - jellyfin
    - quadlet

- name: Install Jellyfin quadlet
  ansible.builtin.template:
    src: jellyfin.container.j2
    dest: /etc/containers/systemd/jellyfin.container
    owner: root
    group: root
    mode: "0644"
  vars:
    jellyfin_config_dir: "{{ jellyfin_home }}/.jellyfin/config"
    jellyfin_cache_dir: "{{ jellyfin_home }}/.jellyfin/cache"
  notify:
    - reload systemd
    - restart jellyfin
  tags:
    - jellyfin
    - quadlet

- name: Flush systemd reload handler
  ansible.builtin.meta: flush_handlers
  tags:
    - jellyfin

- name: Enable and start Jellyfin
  ansible.builtin.systemd:
    name: jellyfin.service
    enabled: true
    state: started
  tags:
    - jellyfin
