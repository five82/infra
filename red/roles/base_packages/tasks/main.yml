---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install base packages
  ansible.builtin.apt:
    name:
      - git
      - neovim
      - curl
      - bash-completion
      - snapraid
      - mergerfs
      - fuse3
      - nfs-kernel-server
      - samba
    state: present

- name: Download Starship installer
  ansible.builtin.get_url:
    url: https://starship.rs/install.sh
    dest: /tmp/starship-install.sh
    mode: "0755"

- name: Install Starship
  ansible.builtin.command:
    cmd: /tmp/starship-install.sh -y
    creates: /usr/local/bin/starship

- name: Manage user .bashrc
  ansible.builtin.copy:
    src: bashrc
    dest: "{{ ansible_env.HOME }}/.bashrc"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: "0644"

- name: Set system timezone to America/New_York
  ansible.builtin.command:
    cmd: timedatectl set-timezone America/New_York
  changed_when: false

- name: Ensure mount points exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /mnt/das1
    - /mnt/das2
    - /mnt/das3
    - /mnt/parity1
    - /media/daspool

- name: Mount data disks
  ansible.builtin.mount:
    path: "{{ item.path }}"
    src: "{{ item.src }}"
    fstype: xfs
    opts: defaults
    state: mounted
  loop:
    - { path: /mnt/das1, src: "LABEL=das1" }
    - { path: /mnt/das2, src: "LABEL=das2" }
    - { path: /mnt/das3, src: "LABEL=das3" }

- name: Mount parity disk
  ansible.builtin.mount:
    path: /mnt/parity1
    src: "LABEL=parity1"
    fstype: xfs
    opts: defaults
    state: mounted

- name: Allow FUSE allow_other
  ansible.builtin.lineinfile:
    path: /etc/fuse.conf
    regexp: '^#?user_allow_other'
    line: 'user_allow_other'
    state: present

- name: Mount mergerfs pool
  ansible.builtin.mount:
    path: /media/daspool
    src: /mnt/das1:/mnt/das2:/mnt/das3
    fstype: fuse.mergerfs
    opts: defaults,allow_other,use_ino,category.create=mfs,moveonenospc=true
    state: mounted

- name: Install snapraid configuration
  ansible.builtin.template:
    src: snapraid.conf.j2
    dest: /etc/snapraid.conf
    owner: root
    group: root
    mode: "0644"

- name: Ensure NFS exports.d directory exists
  ansible.builtin.file:
    path: /etc/exports.d
    state: directory
    mode: "0755"

- name: Install NFS export for daspool
  ansible.builtin.template:
    src: daspool.exports.j2
    dest: /etc/exports.d/daspool.exports
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload NFS exports

- name: Enable and start NFS server
  ansible.builtin.systemd:
    name: nfs-kernel-server
    enabled: true
    state: started

- name: Ensure Samba config include directory exists
  ansible.builtin.file:
    path: /etc/samba/smb.conf.d
    state: directory
    mode: "0755"

- name: Remove any existing Samba conf.d include lines
  ansible.builtin.replace:
    path: /etc/samba/smb.conf
    regexp: '^[;#]?\\s*include\\s*=\\s*/etc/samba/smb\\.conf\\.d/.*$\\n?'
    replace: ''
  notify: Restart Samba

- name: Ensure Samba includes conf.d in [global]
  ansible.builtin.ini_file:
    path: /etc/samba/smb.conf
    section: global
    option: include
    value: /etc/samba/smb.conf.d/daspool.conf
  notify: Restart Samba

- name: Install Samba share for daspool
  ansible.builtin.template:
    src: daspool.smb.conf.j2
    dest: /etc/samba/smb.conf.d/daspool.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart Samba

- name: Ensure Samba services are enabled and started
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - smbd
    - nmbd

- name: Check for Samba user
  ansible.builtin.command:
    cmd: pdbedit -L
  register: samba_users
  changed_when: false

- name: Ensure Samba user exists and has password
  ansible.builtin.command:
    cmd: smbpasswd -s -a ken
  args:
    stdin: "{{ smb_password }}\n{{ smb_password }}\n"
  when: "'ken:' not in samba_users.stdout"
  no_log: true

- name: Install snapraid systemd units
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
    owner: root
    group: root
    mode: "0644"
  loop:
    - snapraid-sync.service
    - snapraid-sync.timer
    - snapraid-scrub.service
    - snapraid-scrub.timer
  notify: Reload systemd

- name: Enable and start snapraid timers
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - snapraid-sync.timer
    - snapraid-scrub.timer
