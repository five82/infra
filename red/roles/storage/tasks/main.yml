---
- name: Install storage packages
  ansible.builtin.apt:
    name: "{{ storage_packages }}"
    state: present
  tags:
    - storage
    - apt

- name: Ensure data disk mount points exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: "0755"
  loop: "{{ storage_data_disks }}"
  tags:
    - storage
    - mounts

- name: Ensure parity disk mount point exists
  ansible.builtin.file:
    path: "{{ storage_parity_disk.path }}"
    state: directory
    mode: "0755"
  tags:
    - storage
    - mounts

- name: Ensure pool mount point exists
  ansible.builtin.file:
    path: "{{ storage_pool_path }}"
    state: directory
    mode: "0755"
  tags:
    - storage
    - mounts

- name: Mount data disks
  ansible.builtin.mount:
    path: "{{ item.path }}"
    src: "LABEL={{ item.label }}"
    fstype: xfs
    opts: defaults
    state: mounted
  loop: "{{ storage_data_disks }}"
  tags:
    - storage
    - mounts

- name: Mount parity disk
  ansible.builtin.mount:
    path: "{{ storage_parity_disk.path }}"
    src: "LABEL={{ storage_parity_disk.label }}"
    fstype: xfs
    opts: defaults
    state: mounted
  tags:
    - storage
    - mounts

- name: Allow FUSE allow_other
  ansible.builtin.lineinfile:
    path: /etc/fuse.conf
    regexp: '^#?user_allow_other'
    line: 'user_allow_other'
    state: present
  tags:
    - storage
    - config

- name: Mount mergerfs pool
  ansible.builtin.mount:
    path: "{{ storage_pool_path }}"
    src: "{{ storage_pool_sources }}"
    fstype: fuse.mergerfs
    opts: "{{ storage_pool_opts }}"
    state: mounted
  tags:
    - storage
    - mounts
